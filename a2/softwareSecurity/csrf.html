<html>
	<body>
		<h1> # FIX OWASP A8: CSRF (Cross Site Request Forgery) </h1>
		<h2> The Vulnerability </h2>
		<ul>
			<li> Brief explanation:
<xmp>
A CSRF vulnerability is when an attacker forces a logged in victim to send a forged HTTP request. This request
can involve the user session cookie or any authentication information. The attacker can force a victim to 
generate request where the page thinks that the request is legitimate.
</xmp>
			</li>
			<li> Example code etc.:
<xmp>
	elseif($operation == "deleteExpression"){
		...
	}	
	elseif($operation == "addExpression") {
		...
	}
	elseif($operation == "logout"){
		...
	}
	
	...
	
	<a href=?operation=logout>Logout</a>
	...
	$deleteLink="<a href=\"?operation=deleteExpression&expressionId=$expressionId&accountId=$g_accountId\"><img src=\"delete.png\" width=\"20\" border=\"0\" /></a>";
	
	
</xmp>
			</li>
			<li> How attacker exploits this: 
<xmp>
</xmp>
			</li>
			<li> Impact: CIAaa and some details
<xmp>
This would fall under Integrity as expression from database are forcefully being changed by an attacker
and an unsuspecting victim.
This would also fall under authentication because expressions from users are now not genuine as an attacker
is added/deleting expressions from other users.
</xmp>
			</li>
		</ul>

		<h2> INSTRUCTIONS TO VERIFY VULNERABILITY BELOW </h2>
<xmp>
Given that an attacker knows the format of the URL when a deleting/adding expressions,
an attacker send a victim these links to:
	
	http://192.168.10.100/fourFours/index.php?operation=logout
	
	to forcefully logout a user from their own account.
	
	http://192.168.10.100/fourFours/index.php?operation=deleteExpression&expressionId=1&accountId=10
	
	to forcefully delete a users entry. (this is logged into username: perl, password: perl)
	
	http://192.168.10.100/fourFours/index.php?operation=addExpression&expression=4+4&accountId=1
	
	to forcefully add an entry.
</xmp>
		<h2> The Fix </h2>
		<ul>
			<li> Explain the fix: 
<xmp>
if($operation == "login"){
		...
		if($row = pg_fetch_row($result)) {
			$_SESSION['accountId']=$row[0];
			$_SESSION['user']=$row[1];
			$_SESSION['firstName']=$row[2];
			$_SESSION['lastName']=$row[3];
			$_SESSION['token']=md5(uniqid(rand(), TRUE));
			$_SESSION['isLoggedIn']=True;
		} else {
			$g_debug = "$user not logged in";
			$_SESSION['isLoggedIn']=False;
		}
	} elseif($operation == "deleteExpression" && $_REQUEST['token'] == $_SESSION['token']){
		...
	} elseif($operation == "addExpression" && $_REQUEST['token'] == $_SESSION['token']){
		...
	} elseif($operation == "logout" && $_REQUEST['token'] == $_SESSION['token']){
		...
	}
	
	...
	
	
	<? if($g_isLoggedIn){ ?>
			<a href=?operation=logout&token=<?= $_SESSION['token']; ?>>Logout</a>
			
			...
			
			if($expressionAccountId==$g_accountId){
				$deleteLink="<a href=\"?operation=deleteExpression&token=".$_SESSION['token']."&expressionId=$expressionId&accountId=$g_accountId\"><img src=\"delete.png\" width=\"20\" border=\"0\" /></a>";
			} else {
				$deleteLink="";
			}
			echo("<tr> <td>$expression</td><td>$deleteLink</td><td>$firstName $lastName</td></tr>");
			
			...
			<form method="post">
				<td><input type="text" name="expression"/> </td>
				<td><input type="submit" value="add"/></td>
				<input type="hidden" name="value" value="<?=$i?>"/>
				<input type="hidden" name="operation" value="addExpression"/>
				<input type="hidden" name="accountId" value="<?=$g_accountId ?>"/>
				<input type="hidden" name="token" value="<?= $_SESSION['token']; ?>"/>
			</form>
			
	
	When a user logs in we create a token that is stored in the session and add it to all our request post 
	forms to verify that the user cannot be sent any links to be sesceptible to CSRF.
			
</xmp>
			</li>
			<li> How the fix resolves the issue:
<xmp>
	Whenever a user logs in, a new token is generated by hash and stored in the session and added to the URL and 
	is hidden from the user and attacker. This token is then added to all our request and post forms so that
	the URL is now as follows:
	
	http://192.168.10.100/fourFours/index.php?operation=logout&token=195e0b3c6cb95a5e36521f7d21b70425
	
	This means in order to logout, a user would need the operation and their session's token. However the token is hidden
	and stored in the session so no user would be able to find out.
	Since a token is unique per session, an attacker will not have the same token as another user therefore when
	they try and force a victim to logout using a suspicious link, then the user will not be logged out. The attacker
	would somehow have to guess the token by random in order for the attacker to force another user to logout. By tokenizing,
	we can protect users from malicious links.
	
	This applies the same for deleting expressions and adding expressions.
</xmp>
			</li>
		</ul>
	</body>
</html>
